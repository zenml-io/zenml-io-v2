---
/**
 * BlogLayout — chrome for blog post detail pages.
 *
 * "Clean & Structured" design with:
 * - Reading progress bar
 * - Back to Blog link
 * - Display title (separate from SEO title) + optional dek
 * - Author byline + avatar
 * - Desktop sidebar TOC + mobile inline collapsible TOC
 * - Author bio card after content
 * - Prev/Next navigation cards
 * - Related posts ("Continue Reading") section
 */
import BaseLayout from "./BaseLayout.astro";
import Badge from "../components/Badge.astro";
import Image from "../components/Image.astro";
import JsonLd from "../components/seo/JsonLd.astro";
import BlogTOC from "../components/BlogTOC.astro";
import BlogCard from "../components/blog/BlogCard.astro";
import CategoryBar from "../components/blog/CategoryBar.astro";
import type { SEOProps } from "../lib/seo";
import { SITE_URL } from "../lib/constants";

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Author {
  name: string;
  slug: string;
  avatar?: { url: string; alt?: string; width?: number; height?: number };
  bio?: string;
}

interface PrevNextLink {
  title: string;
  href: string;
}

interface RelatedPost {
  href: string;
  title: string;
  excerpt?: string;
  image?: { url: string; alt?: string; width?: number; height?: number };
  authorName?: string;
  authorSlug?: string;
  readingTime?: string;
  categoryName?: string;
  categorySlug?: string;
}

interface Props extends SEOProps {
  /** Display title (shown as h1 — may differ from SEO title) */
  postTitle?: string;
  /** Subtitle/excerpt shown under the title */
  dek?: string;
  /** Post date (ISO string or Date) */
  date: Date;
  /** Author data (resolved from collection) */
  author?: Author;
  /** Category name */
  category?: string;
  /** Category slug (for linking) */
  categorySlug?: string;
  /** Reading time string (e.g. "5 min read") */
  readingTime?: string;
  /** Featured image */
  mainImage?: { url: string; alt?: string; width?: number; height?: number };
  /** Headings extracted from markdown for TOC */
  headings?: Heading[];
  /** Previous post link */
  prev?: PrevNextLink;
  /** Next post link */
  next?: PrevNextLink;
  /** Related posts for "Continue Reading" */
  relatedPosts?: RelatedPost[];
}

const {
  postTitle,
  dek,
  date,
  author,
  category,
  categorySlug,
  readingTime,
  mainImage,
  headings = [],
  prev,
  next,
  relatedPosts = [],
  ...seoProps
} = Astro.props;

// Display title: prefer postTitle (the actual post title), fall back to SEO title
const displayTitle = postTitle || seoProps.title;


// H2-only TOC — consistent with BlogTOC.astro desktop sidebar
const tocHeadings = headings.filter((h) => h.depth === 2);
const showTOC = tocHeadings.length >= 3;

const formattedDate = new Date(date).toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

// Structured data (JSON-LD)
const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Blog", item: `${SITE_URL}/blog` },
    { "@type": "ListItem", position: 2, name: displayTitle },
  ],
};

const articleJsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: displayTitle,
  datePublished: new Date(date).toISOString(),
  ...(author && { author: { "@type": "Person", name: author.name } }),
  publisher: { "@type": "Organization", name: "ZenML", url: SITE_URL },
  ...(mainImage && { image: mainImage.url }),
  ...(seoProps.description && { description: seoProps.description }),
};
---

<BaseLayout {...seoProps}>
  <JsonLd data={articleJsonLd} slot="head" />
  <JsonLd data={breadcrumbJsonLd} slot="head" />

  {/* Sticky breadcrumb bar: Blog / Post Title */}
  <CategoryBar breadcrumbTitle={displayTitle} />

  {/* Reading progress bar */}
  <div class="sticky top-[116px] z-30 h-0.5" id="progress-container">
    <div class="h-full w-0 bg-primary-600 transition-[width] duration-150" id="progress-bar"></div>
  </div>

  {/* Editorial post header — full-width, separated from content */}
  <section class="bg-linear-to-t from-primary-50 to-white border-b border-gray-200">
    <div class="mx-auto max-w-[1440px] px-4 py-10 sm:px-6 sm:py-14 lg:px-8">
      <div class:list={[
        "grid items-center gap-8",
        mainImage ? "lg:grid-cols-2 lg:gap-12" : "mx-auto max-w-3xl",
      ]}>
        {/* Left: text content */}
        <div>
          {/* Meta line: category · date · reading time */}
          <div class="mb-4 flex flex-wrap items-center gap-2 text-sm text-gray-500">
            {category && (
              <>
                {categorySlug ? (
                  <a
                    href={`/category/${categorySlug}`}
                    class="inline-flex items-center rounded-full bg-primary-50 px-2.5 py-0.5 text-xs font-semibold text-primary-700 transition-colors hover:bg-primary-100"
                    style="mix-blend-mode:multiply"
                  >
                    {category}
                  </a>
                ) : (
                  <span class="inline-flex items-center rounded-full bg-primary-50 px-2.5 py-0.5 text-xs font-semibold text-primary-700" style="mix-blend-mode:multiply">
                    {category}
                  </span>
                )}
                {(formattedDate || readingTime) && (
                  <span class="text-gray-300" aria-hidden="true">&middot;</span>
                )}
              </>
            )}
            <time datetime={new Date(date).toISOString()}>{formattedDate}</time>
            {readingTime && (
              <>
                <span class="text-gray-300" aria-hidden="true">&middot;</span>
                <span>{readingTime}</span>
              </>
            )}
          </div>

          {/* Title */}
          <h1 class="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">
            {displayTitle}
          </h1>

          {/* Dek / subtitle */}
          {dek && (
            <p class="mt-4 text-base leading-relaxed text-gray-600 line-clamp-3">
              {dek}
            </p>
          )}

          {/* Author byline */}
          <div class="mt-6 flex items-center gap-3 text-sm text-gray-500">
            {author && (
              <>
                {author.avatar && (
                  <Image
                    image={author.avatar}
                    alt={author.name}
                    class="h-8 w-8 rounded-full object-cover"
                    loading="eager"
                  />
                )}
                <a
                  href={`/author/${author.slug}`}
                  class="font-medium text-gray-700 hover:text-primary-600"
                >
                  {author.name}
                </a>
              </>
            )}
          </div>
        </div>

        {/* Right: featured image */}
        {mainImage && (
          <div class="overflow-hidden rounded-md">
            <Image
              image={mainImage}
              alt={mainImage.alt || displayTitle}
              class="aspect-[3/2] w-full rounded-md object-cover"
              loading="eager"
            />
          </div>
        )}
      </div>
    </div>
  </section>

  {/* Content area */}
  <div class:list={[
    "mx-auto px-4 py-8 sm:px-6 lg:py-12",
    showTOC ? "max-w-5xl xl:grid xl:grid-cols-[minmax(0,48rem)_14rem] xl:gap-10" : "max-w-3xl",
  ]}>
    <article>

      {/* Mobile inline TOC (visible below xl, collapsible) */}
      {showTOC && (
        <details class="mb-8 rounded-md border border-gray-200 bg-gray-50 xl:hidden" id="mobile-toc">
          <summary class="cursor-pointer select-none px-5 py-3 text-sm font-semibold text-gray-700">
            On this page
          </summary>
          <nav class="px-5 pb-4" aria-label="Table of contents">
            <ul class="space-y-1.5">
              {tocHeadings.map((heading) => (
                <li>
                  <a
                    href={`#${heading.slug}`}
                    class="block text-sm text-gray-600 transition-colors hover:text-primary-600"
                    data-mobile-toc-link
                  >
                    {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </nav>
        </details>
      )}

      {/* Post body */}
      <div class="prose">
        <slot />
      </div>

      {/* Author bio card */}
      {author && (
        <div class="mt-10 flex items-center gap-4 rounded-md border border-gray-200 bg-gray-50 p-5">
          {author.avatar && (
            <a href={`/author/${author.slug}`} class="shrink-0">
              <Image
                image={author.avatar}
                alt={author.name}
                class="h-14 w-14 rounded-full object-cover"
              />
            </a>
          )}
          <div>
            <a
              href={`/author/${author.slug}`}
              class="font-semibold text-gray-900 hover:text-primary-600"
            >
              {author.name}
            </a>
            {author.bio ? (
              <p class="mt-1 text-sm leading-relaxed text-gray-600">{author.bio}</p>
            ) : (
              <p class="mt-1 text-sm text-gray-500">
                <a href={`/author/${author.slug}`} class="text-primary-600 hover:text-primary-700">
                  View all posts &rarr;
                </a>
              </p>
            )}
          </div>
        </div>
      )}

      {/* Prev/Next navigation */}
      {(prev || next) && (
        <div class="mt-10 grid gap-6 sm:grid-cols-2">
          {prev ? (
            <a
              href={prev.href}
              class="group flex flex-col rounded-md border border-gray-200 p-5 transition-all hover:border-gray-300 hover:shadow-sm"
            >
              <span class="text-xs font-medium text-gray-500 group-hover:text-primary-600">&larr; Previous</span>
              <span class="mt-2 line-clamp-2 text-sm font-semibold text-gray-900 group-hover:text-primary-600">{prev.title}</span>
            </a>
          ) : <div />}
          {next ? (
            <a
              href={next.href}
              class="group flex flex-col rounded-md border border-gray-200 p-5 text-right transition-all hover:border-gray-300 hover:shadow-sm"
            >
              <span class="text-xs font-medium text-gray-500 group-hover:text-primary-600">Next &rarr;</span>
              <span class="mt-2 line-clamp-2 text-sm font-semibold text-gray-900 group-hover:text-primary-600">{next.title}</span>
            </a>
          ) : <div />}
        </div>
      )}
    </article>

    {/* Desktop Table of contents sidebar */}
    {showTOC && (
      <aside class="hidden xl:block">
        <div class="sticky top-32 max-h-[calc(100vh-9rem)] overflow-y-auto">
          <BlogTOC headings={tocHeadings} />
        </div>
      </aside>
    )}
  </div>

  {/* Continue Reading — related posts (full width, outside the article grid) */}
  {relatedPosts.length > 0 && (
    <div class="border-t border-gray-200 bg-gray-50">
      <div class="mx-auto max-w-[1440px] px-4 py-12 sm:px-6 lg:px-8 lg:py-16">
        <h2 class="mb-8 text-2xl font-bold text-gray-900">Continue Reading</h2>
        <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
          {relatedPosts.map((rp) => (
            <BlogCard
              href={rp.href}
              title={rp.title}
              excerpt={rp.excerpt}
              image={rp.image}
              authorName={rp.authorName}
              authorSlug={rp.authorSlug}
              readingTime={rp.readingTime}
              categoryName={rp.categoryName}
              categorySlug={rp.categorySlug}
            />
          ))}
        </div>
      </div>
    </div>
  )}
</BaseLayout>

<script>
  // Reading progress bar
  function initProgress() {
    const bar = document.getElementById('progress-bar');
    if (!bar) return;
    const barEl = bar;

    function updateProgress() {
      const scrollTop = window.scrollY;
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const progress = docHeight > 0 ? Math.min((scrollTop / docHeight) * 100, 100) : 0;
      barEl.style.width = progress + '%';
    }

    window.addEventListener('scroll', updateProgress, { passive: true });
    updateProgress();
  }

  // Close mobile TOC when a link is clicked
  function initMobileTOC() {
    const details = document.getElementById('mobile-toc');
    if (!details) return;

    details.querySelectorAll('a[data-mobile-toc-link]').forEach((link) => {
      link.addEventListener('click', () => {
        (details as HTMLDetailsElement).open = false;
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => { initProgress(); initMobileTOC(); });
  } else {
    initProgress();
    initMobileTOC();
  }
</script>
