---
/**
 * Category taxonomy page.
 *
 * Shows all blog posts in this category using the shared BlogCard component.
 * Generates /category/<slug> for each category in the collection.
 */
import { getCollection, getEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import BlogCard from "../../components/blog/BlogCard.astro";
import { resolveAuthor } from "../../lib/blog";

export async function getStaticPaths() {
  const categories = await getCollection("categories");
  return categories.map((cat) => ({
    params: { slug: cat.data.slug },
    props: { category: cat },
  }));
}

const { category } = Astro.props;

const allPosts = (
  await getCollection("blog", ({ data }) => !data.draft && data.category === category.data.slug)
).sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// Resolve authors for display
const authorMap = new Map<string, { name: string; slug: string }>();
for (const post of allPosts) {
  if (post.data.author && !authorMap.has(post.data.author)) {
    const a = await resolveAuthor(post.data.author);
    if (a) authorMap.set(post.data.author, a);
  }
}
---

<BaseLayout
  title={`${category.data.name} - ZenML Blog`}
  description={`Blog posts about ${category.data.name} from the ZenML team.`}
>
  <div class="mx-auto max-w-[1440px] px-4 py-12 sm:px-6 lg:px-8">
    <header class="mb-10">
      <a href="/blog" class="mb-4 inline-flex items-center gap-1.5 text-sm font-medium text-primary-600 hover:text-primary-700">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" class="shrink-0">
          <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Back to Blog
      </a>
      <h1 class="text-4xl font-bold tracking-tight text-gray-900">{category.data.name}</h1>
      <p class="mt-3 text-lg text-gray-600">
        {allPosts.length} {allPosts.length === 1 ? "post" : "posts"} in this category
      </p>
    </header>

    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      {allPosts.map((post) => {
        const author = authorMap.get(post.data.author || "");
        return (
          <BlogCard
            href={`/blog/${post.data.slug}`}
            title={post.data.title}
            excerpt={post.data.seo?.description}
            image={post.data.mainImage}
            authorName={author?.name}
            authorSlug={author?.slug}
            readingTime={post.data.readingTime}
          />
        );
      })}
    </div>

    {allPosts.length === 0 && (
      <p class="text-center text-gray-500">No posts in this category yet.</p>
    )}
  </div>
</BaseLayout>
