---
/**
 * Blog tag taxonomy page.
 *
 * Shows all blog posts with this tag using the CategoryBar for navigation
 * and TagCloud at the bottom.
 */
import { getCollection, getEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import BlogCard from "../../components/blog/BlogCard.astro";
import CategoryBar from "../../components/blog/CategoryBar.astro";
import TagCloud from "../../components/blog/TagCloud.astro";
import {
  resolveAuthor,
  getMainFeedPosts,
  getCategoryCounts,
  getTagCounts,
} from "../../lib/blog";

export async function getStaticPaths() {
  const tags = await getCollection("tags");
  return tags.map((tag) => ({
    params: { slug: tag.data.slug },
    props: { tag },
  }));
}

const { tag } = Astro.props;

const allPosts = (
  await getCollection("blog", ({ data }) => !data.draft && data.tags.includes(tag.data.slug))
).sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// CategoryBar needs all main feed posts for counts
const mainFeedPosts = await getMainFeedPosts();
const categories = await getCategoryCounts(mainFeedPosts);
const popularTags = await getTagCounts(mainFeedPosts);

// Resolve authors and categories
const authorMap = new Map<string, Awaited<ReturnType<typeof resolveAuthor>>>();
const categoryMap = new Map<string, { name: string; slug: string }>();
for (const post of allPosts) {
  if (post.data.author && !authorMap.has(post.data.author)) {
    const a = await resolveAuthor(post.data.author);
    if (a) authorMap.set(post.data.author, a);
  }
  if (post.data.category && !categoryMap.has(post.data.category)) {
    const cat = await getEntry("categories", post.data.category);
    if (cat) categoryMap.set(post.data.category, { name: cat.data.name, slug: cat.data.slug });
  }
}

// Build search index
for (const p of mainFeedPosts) {
  if (p.data.category && !categoryMap.has(p.data.category)) {
    const cat = await getEntry("categories", p.data.category);
    if (cat) categoryMap.set(p.data.category, { name: cat.data.name, slug: cat.data.slug });
  }
}
const searchIndex = mainFeedPosts.map((p) => ({
  title: p.data.title,
  slug: p.data.slug,
  excerpt: p.data.seo?.description || "",
  date: p.data.date.toISOString(),
  category: categoryMap.get(p.data.category || "")?.name || "",
}));
---

<BaseLayout
  title={`Posts tagged "${tag.data.name}" - ZenML Blog`}
  description={`Blog posts tagged with "${tag.data.name}" from the ZenML team.`}
>
  {/* Section header: sticky CategoryBar with back link */}
  <CategoryBar categories={categories} backLink searchIndex={searchIndex} />

  {/* Tag header â€” gradient section */}
  <section class="bg-linear-to-t from-primary-50 to-white border-b border-gray-200">
    <div class="mx-auto max-w-[1440px] px-4 py-10 sm:px-6 sm:py-14 lg:px-8">
      <h1 class="text-3xl font-bold tracking-tight text-gray-900">
        Tag: {tag.data.name}
      </h1>
      <p class="mt-2 text-base text-gray-600">
        {allPosts.length} {allPosts.length === 1 ? "post" : "posts"} with this tag
      </p>
    </div>
  </section>

  <div class="mx-auto max-w-[1440px] px-4 py-10 sm:px-6 lg:px-8">
    <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
      {allPosts.map((post) => {
        const author = authorMap.get(post.data.author || "");
        const category = categoryMap.get(post.data.category || "");
        return (
          <BlogCard
            href={`/blog/${post.data.slug}`}
            title={post.data.title}
            excerpt={post.data.seo?.description}
            image={post.data.mainImage}
            authorName={author?.name}
            authorSlug={author?.slug}
            authorAvatar={author?.avatar}
            readingTime={post.data.readingTime}
            publishedDate={post.data.date}
            categoryName={category?.name}
            categorySlug={category?.slug}
          />
        );
      })}
    </div>

    {allPosts.length === 0 && (
      <p class="text-center text-gray-500">No posts with this tag yet.</p>
    )}
  </div>

  {/* Footer tag cloud with active state */}
  <TagCloud tags={popularTags} activeTag={tag.data.slug} />
</BaseLayout>
