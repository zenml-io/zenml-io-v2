---
/**
 * Blog listing page (page 1).
 *
 * Layout: CategoryBar → hero → 3-col grid → pagination → tag cloud.
 * Page 2+ handled by blog/page/[page].astro.
 */
import { getEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import BlogCard from "../../components/blog/BlogCard.astro";
import BlogHero from "../../components/blog/BlogHero.astro";
import CategoryBar from "../../components/blog/CategoryBar.astro";
import TagCloud from "../../components/blog/TagCloud.astro";
import Pagination from "../../components/Pagination.astro";
import {
  getMainFeedPosts,
  getCategoryCounts,
  getTagCounts,
  resolveAuthor,
  PAGE_SIZE,
  PAGE_1_GRID_COUNT,
  blogPageHref,
} from "../../lib/blog";

const allPosts = await getMainFeedPosts();

// Featured post: prefer a post with `featured: true`, fall back to newest
const featuredPost = allPosts.find((p) => p.data.featured) ?? allPosts[0];
const remainingPosts = allPosts.filter((p) => p !== featuredPost);

// Grid posts — fill rest of page 1 (multiple of 3 for clean 3-col grid)
const gridPosts = remainingPosts.slice(0, PAGE_1_GRID_COUNT);
const totalPages = 1 + Math.ceil(Math.max(remainingPosts.length - PAGE_1_GRID_COUNT, 0) / PAGE_SIZE);

// Taxonomy data
const categories = await getCategoryCounts(allPosts);
const popularTags = await getTagCounts(allPosts);

// Resolve featured post metadata
const featuredCategory = featuredPost?.data.category
  ? await getEntry("categories", featuredPost.data.category)
  : undefined;
const featuredAuthor = await resolveAuthor(featuredPost?.data.author);

// Resolve metadata for grid posts
const authorMap = new Map<string, Awaited<ReturnType<typeof resolveAuthor>>>();
const categoryMap = new Map<string, { name: string; slug: string }>();
for (const post of gridPosts) {
  if (post.data.author && !authorMap.has(post.data.author)) {
    const a = await resolveAuthor(post.data.author);
    if (a) authorMap.set(post.data.author, a);
  }
  if (post.data.category && !categoryMap.has(post.data.category)) {
    const cat = await getEntry("categories", post.data.category);
    if (cat) categoryMap.set(post.data.category, { name: cat.data.name, slug: cat.data.slug });
  }
}

---

<BaseLayout
  title="Blog - ZenML"
  description="Insights on MLOps, LLMOps, and production machine learning from the ZenML team."
>
  {/* Section header: sticky CategoryBar at top */}
  <CategoryBar categories={categories} />

  {/* Editorial Hero */}
  {featuredPost && (
    <BlogHero
      href={`/blog/${featuredPost.data.slug}`}
      title={featuredPost.data.title}
      excerpt={featuredPost.data.seo?.description}
      image={featuredPost.data.mainImage}
      categoryName={featuredCategory?.data.name}
      categorySlug={featuredCategory?.data.slug}
      publishedDate={featuredPost.data.date}
      readingTime={featuredPost.data.readingTime}
      authorName={featuredAuthor?.name}
      authorSlug={featuredAuthor?.slug}
      authorAvatar={featuredAuthor?.avatar}
    />
  )}

  <div class="mx-auto max-w-[1440px] px-4 sm:px-6 lg:px-8">
    {/* Post Grid */}
    {gridPosts.length > 0 && (
      <div class="grid gap-8 pt-10 pb-2 md:grid-cols-2 xl:grid-cols-3">
        {gridPosts.map((post) => {
          const author = authorMap.get(post.data.author || "");
          const category = categoryMap.get(post.data.category || "");
          return (
            <BlogCard
              href={`/blog/${post.data.slug}`}
              title={post.data.title}
              excerpt={post.data.seo?.description}
              image={post.data.mainImage}
              authorName={author?.name}
              authorSlug={author?.slug}
              authorAvatar={author?.avatar}
              readingTime={post.data.readingTime}
              publishedDate={post.data.date}
              categoryName={category?.name}
              categorySlug={category?.slug}
            />
          );
        })}
      </div>
    )}

    {/* Pagination */}
    <Pagination
      currentPage={1}
      totalPages={totalPages}
      getHref={blogPageHref}
      ariaLabel="Blog pagination"
    />
  </div>

  {/* Footer Tag Cloud */}
  <TagCloud tags={popularTags} />
</BaseLayout>
