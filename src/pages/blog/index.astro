---
/**
 * Blog listing page (page 1).
 *
 * "Clean & Structured" design: sidebar browse + featured hero + 3-col grid.
 * Page 2+ handled by blog/page/[page].astro.
 */
import { getEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import BlogCard from "../../components/blog/BlogCard.astro";
import BlogSidebar from "../../components/blog/BlogSidebar.astro";
import Pagination from "../../components/Pagination.astro";
import Image from "../../components/Image.astro";
import {
  getMainFeedPosts,
  getCategoryCounts,
  getTagCounts,
  resolveAuthor,
  PAGE_SIZE,
  blogPageHref,
} from "../../lib/blog";

const allPosts = await getMainFeedPosts();

// Featured post: prefer a post with `featured: true`, fall back to newest
const featuredPost = allPosts.find((p) => p.data.featured) ?? allPosts[0];
const remainingPosts = allPosts.filter((p) => p !== featuredPost);
const page1Count = PAGE_SIZE - 1; // featured takes one slot
const totalPages = 1 + Math.ceil(Math.max(remainingPosts.length - page1Count, 0) / PAGE_SIZE);
const posts = remainingPosts.slice(0, page1Count);

// Sidebar data
const categories = await getCategoryCounts(allPosts);
const popularTags = await getTagCounts(allPosts);

// Resolve featured post metadata
const featuredCategory = featuredPost?.data.category
  ? await getEntry("categories", featuredPost.data.category)
  : undefined;
const featuredAuthor = await resolveAuthor(featuredPost?.data.author);

// Resolve metadata for grid posts
const authorMap = new Map<string, { name: string; slug: string }>();
const categoryMap = new Map<string, { name: string; slug: string }>();
for (const post of posts) {
  if (post.data.author && !authorMap.has(post.data.author)) {
    const a = await resolveAuthor(post.data.author);
    if (a) authorMap.set(post.data.author, a);
  }
  if (post.data.category && !categoryMap.has(post.data.category)) {
    const cat = await getEntry("categories", post.data.category);
    if (cat) categoryMap.set(post.data.category, { name: cat.data.name, slug: cat.data.slug });
  }
}
---

<BaseLayout
  title="Blog - ZenML"
  description="Insights on MLOps, LLMOps, and production machine learning from the ZenML team."
>
  {/* Purple gradient header */}
  <div class="bg-gradient-to-b from-primary-50 to-white">
    <div class="mx-auto max-w-7xl px-4 py-16 sm:px-6 sm:py-20 lg:px-8">
      <div class="text-center">
        <h1 class="text-4xl font-bold tracking-tight text-gray-900 sm:text-5xl">ZenML Blog</h1>
        <p class="mx-auto mt-4 max-w-2xl text-lg text-gray-600">
          The latest news, opinions and technical guides from ZenML.
        </p>
      </div>
    </div>
  </div>

  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    {/* Sidebar + Content grid */}
    <div class="gap-10 pb-12 lg:grid lg:grid-cols-[220px_1fr]">
      <BlogSidebar categories={categories} popularTags={popularTags} />

      <div>
        {/* Featured post â€” two-column hero layout */}
        {featuredPost && (
          <article class="grid items-center gap-8 py-8 lg:grid-cols-2 lg:gap-12">
            <div>
              {featuredCategory && (
                <div class="mb-4">
                  <a
                    href={`/category/${featuredCategory.data.slug}`}
                    class="inline-flex items-center rounded-full bg-primary-50 px-3 py-1 text-xs font-semibold text-primary-700 transition-colors hover:bg-primary-100"
                    style="mix-blend-mode:multiply"
                  >
                    {featuredCategory.data.name}
                    {featuredPost.data.readingTime && (
                      <span class="ml-2 border-l border-primary-200 pl-2">{featuredPost.data.readingTime}</span>
                    )}
                  </a>
                </div>
              )}
              <h2 class="text-2xl font-bold text-gray-900 sm:text-3xl">
                <a href={`/blog/${featuredPost.data.slug}`} class="transition-colors hover:text-primary-600">
                  {featuredPost.data.title}
                </a>
              </h2>
              {featuredPost.data.seo?.description && (
                <p class="mt-4 text-base leading-relaxed text-gray-600">
                  {featuredPost.data.seo.description}
                </p>
              )}
              <div class="mt-4 flex items-center gap-3 text-sm text-gray-500">
                {featuredAuthor && (
                  <a href={`/author/${featuredAuthor.slug}`} class="font-medium text-gray-700 hover:text-primary-600">
                    {featuredAuthor.name}
                  </a>
                )}
                {featuredAuthor && featuredPost.data.readingTime && (
                  <span class="text-gray-300" aria-hidden="true">&middot;</span>
                )}
                {featuredPost.data.readingTime && <span>{featuredPost.data.readingTime}</span>}
              </div>
            </div>
            {featuredPost.data.mainImage && (
              <a href={`/blog/${featuredPost.data.slug}`} class="block overflow-hidden rounded-xl">
                <Image
                  image={featuredPost.data.mainImage}
                  alt={featuredPost.data.mainImage.alt || featuredPost.data.title}
                  class="w-full rounded-xl object-cover"
                />
              </a>
            )}
          </article>
        )}

        {/* Divider */}
        <hr class="border-gray-200" />

        {/* Post grid */}
        <div class="grid gap-6 py-8 md:grid-cols-2 xl:grid-cols-3">
          {posts.map((post) => {
            const author = authorMap.get(post.data.author || "");
            const category = categoryMap.get(post.data.category || "");
            return (
              <BlogCard
                href={`/blog/${post.data.slug}`}
                title={post.data.title}
                excerpt={post.data.seo?.description}
                image={post.data.mainImage}
                authorName={author?.name}
                authorSlug={author?.slug}
                readingTime={post.data.readingTime}
                categoryName={category?.name}
                categorySlug={category?.slug}
              />
            );
          })}
        </div>

        {/* Pagination */}
        <Pagination
          currentPage={1}
          totalPages={totalPages}
          getHref={blogPageHref}
          ariaLabel="Blog pagination"
        />
      </div>
    </div>
  </div>
</BaseLayout>
