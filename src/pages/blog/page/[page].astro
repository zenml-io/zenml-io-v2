---
/**
 * Paginated blog listing (page 2+).
 *
 * Grid-only layout with CategoryBar at top and TagCloud at bottom.
 * Page 1 is handled by blog/index.astro.
 */
import { getEntry } from "astro:content";
import BaseLayout from "../../../layouts/BaseLayout.astro";
import BlogCard from "../../../components/blog/BlogCard.astro";
import CategoryBar from "../../../components/blog/CategoryBar.astro";
import TagCloud from "../../../components/blog/TagCloud.astro";
import Pagination from "../../../components/Pagination.astro";
import {
  getMainFeedPosts,
  getCategoryCounts,
  getTagCounts,
  resolveAuthor,
  PAGE_SIZE,
  PAGE_1_GRID_COUNT,
  blogPageHref,
} from "../../../lib/blog";

export async function getStaticPaths() {
  const allPosts = await getMainFeedPosts();
  const featuredPost = allPosts.find((p) => p.data.featured) ?? allPosts[0];
  const remainingPosts = allPosts.filter((p) => p !== featuredPost);
  const totalPages = 1 + Math.ceil(Math.max(remainingPosts.length - PAGE_1_GRID_COUNT, 0) / PAGE_SIZE);

  return Array.from({ length: totalPages - 1 }, (_, i) => {
    const page = i + 2;
    const start = PAGE_1_GRID_COUNT + (page - 2) * PAGE_SIZE;
    return {
      params: { page: String(page) },
      props: {
        posts: remainingPosts.slice(start, start + PAGE_SIZE),
        currentPage: page,
        totalPages,
        allPosts,
      },
    };
  });
}

const { posts, currentPage, totalPages, allPosts } = Astro.props;

// Taxonomy data
const categories = await getCategoryCounts(allPosts);
const popularTags = await getTagCounts(allPosts);

// Resolve metadata
const authorMap = new Map<string, Awaited<ReturnType<typeof resolveAuthor>>>();
const categoryMap = new Map<string, { name: string; slug: string }>();
for (const post of posts) {
  if (post.data.author && !authorMap.has(post.data.author)) {
    const a = await resolveAuthor(post.data.author);
    if (a) authorMap.set(post.data.author, a);
  }
  if (post.data.category && !categoryMap.has(post.data.category)) {
    const cat = await getEntry("categories", post.data.category);
    if (cat) categoryMap.set(post.data.category, { name: cat.data.name, slug: cat.data.slug });
  }
}

---

<BaseLayout
  title={`Blog - Page ${currentPage} - ZenML`}
  description="Insights on MLOps, LLMOps, and production machine learning from the ZenML team."
>
  {/* Section header: sticky CategoryBar at top */}
  <CategoryBar categories={categories} />

  <div class="mx-auto max-w-[1440px] px-4 sm:px-6 lg:px-8">
    {/* Post grid */}
    <div class="grid gap-8 py-10 md:grid-cols-2 xl:grid-cols-3">
      {posts.map((post) => {
        const author = authorMap.get(post.data.author || "");
        const category = categoryMap.get(post.data.category || "");
        return (
          <BlogCard
            href={`/blog/${post.data.slug}`}
            title={post.data.title}
            excerpt={post.data.seo?.description}
            image={post.data.mainImage}
            authorName={author?.name}
            authorSlug={author?.slug}
            authorAvatar={author?.avatar}
            readingTime={post.data.readingTime}
            publishedDate={post.data.date}
            categoryName={category?.name}
            categorySlug={category?.slug}
          />
        );
      })}
    </div>

    {/* Pagination */}
    <Pagination
      currentPage={currentPage}
      totalPages={totalPages}
      getHref={blogPageHref}
      ariaLabel="Blog pagination"
    />
  </div>

  {/* Footer tag cloud */}
  <TagCloud tags={popularTags} />
</BaseLayout>
