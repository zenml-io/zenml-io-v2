---
/**
 * LLMOps tag taxonomy page.
 *
 * Shows all LLMOps database entries with this tag.
 * Generates /llmops-tags/<slug> for each tag in the collection.
 */
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Badge from "../../components/Badge.astro";
import { getIndustryTagCounts } from "../../lib/llmops";

export async function getStaticPaths() {
  const llmopsTags = await getCollection("llmops-tags");
  const tagMap = Object.fromEntries(llmopsTags.map((t) => [t.data.slug, t.data.name]));
  return llmopsTags.map((tag) => ({
    params: { slug: tag.data.slug },
    props: { tag, tagMap },
  }));
}

const { tag, tagMap } = Astro.props;

// Get all published LLMOps entries with this tag
const allEntries = (
  await getCollection("llmops-database", ({ data }) => !data.draft && data.llmopsTags.includes(tag.data.slug))
).sort((a, b) => a.data.title.localeCompare(b.data.title));

// Compute top co-occurring industries among entries with this tag
const commonIndustries = (await getIndustryTagCounts(allEntries)).slice(0, 8);
---

<BaseLayout
  title={`${tag.data.name} - LLMOps Database`}
  description={`LLMOps tools and platforms tagged with "${tag.data.name}".`}
>
  <div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
    <header class="mb-12">
      <h1 class="text-4xl font-bold tracking-tight text-gray-900">
        LLMOps Tag: {tag.data.name}
      </h1>
      <p class="mt-4 text-lg text-gray-600">
        {allEntries.length} {allEntries.length === 1 ? "tool" : "tools"} with this tag
      </p>
      <a href="/llmops-database" class="mt-2 inline-block text-sm text-primary-600 hover:text-primary-700">
        &larr; Back to LLMOps Database
      </a>
    </header>

    {/* Common industries cross-links */}
    {commonIndustries.length > 0 && (
      <section class="mb-10">
        <div class="flex items-baseline justify-between gap-4">
          <h2 class="text-xs font-semibold uppercase tracking-wider text-gray-400">
            Common industries
          </h2>
          <a
            href="/industry-tags"
            class="text-xs font-medium text-primary-600 hover:text-primary-700"
          >
            View all industries &rarr;
          </a>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
          {commonIndustries.map((ind) => (
            <Badge variant="primary" href={`/industry-tags/${ind.slug}`}>
              {ind.name} ({ind.count})
            </Badge>
          ))}
        </div>
      </section>
    )}

    {/* Entry grid */}
    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      {allEntries.map((entry) => (
        <a
          href={`/llmops-database/${entry.data.slug}`}
          class="group flex flex-col rounded-lg border border-gray-200 bg-white p-5 transition-shadow hover:shadow-md"
        >
          <h2 class="text-lg font-semibold text-gray-900 group-hover:text-primary-600">
            {entry.data.title}
          </h2>
          {entry.data.company && (
            <p class="mt-1 text-sm text-gray-500">{entry.data.company}</p>
          )}
          {entry.data.summary && (
            <p class="mt-2 line-clamp-3 text-sm text-gray-600">{entry.data.summary}</p>
          )}
          <div class="mt-auto flex flex-wrap gap-1.5 pt-4">
            {entry.data.llmopsTags.slice(0, 4).map((tagSlug: string) => (
              <Badge variant="blue" href={`/llmops-tags/${tagSlug}`}>{tagMap[tagSlug] || tagSlug}</Badge>
            ))}
            {entry.data.llmopsTags.length > 4 && (
              <Badge variant="gray">+{entry.data.llmopsTags.length - 4}</Badge>
            )}
          </div>
        </a>
      ))}
    </div>

    {allEntries.length === 0 && (
      <p class="text-center text-gray-500">No LLMOps entries with this tag yet.</p>
    )}
  </div>
</BaseLayout>
