---
/**
 * LLMOps Database detail page.
 *
 * Renders individual LLMOps entries with company info, tags, summary, body,
 * and related entries ("More Like This").
 * Generates /llmops-database/<slug> for each published entry.
 */
import { getCollection, getEntry, render } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Badge from "../../components/Badge.astro";
import { getAllPublishedEntries, buildRelatedIndex, getRelatedFromIndex } from "../../lib/llmops";

export async function getStaticPaths() {
  const allEntries = await getAllPublishedEntries();
  const relatedIndex = buildRelatedIndex(allEntries);

  return allEntries.map((entry) => {
    const related = getRelatedFromIndex(relatedIndex, entry, 3);
    return {
      params: { slug: entry.data.slug },
      props: { entry, related },
    };
  });
}

const { entry, related } = Astro.props;
const { Content } = await render(entry);

// Resolve llmops tags for display names
const tagEntries = await Promise.all(
  entry.data.llmopsTags.map((slug: string) => getEntry("llmops-tags", slug))
);
const tags = tagEntries.filter(Boolean).map((t) => ({
  name: t!.data.name,
  slug: t!.data.slug,
}));

// Resolve industry tag
const industryEntry = entry.data.industryTags
  ? await getEntry("industry-tags", entry.data.industryTags)
  : undefined;

// Resolve related entry tags for display
const relatedWithTags = await Promise.all(
  related.map(async (r) => {
    const rTags = await Promise.all(
      r.data.llmopsTags.slice(0, 3).map((s: string) => getEntry("llmops-tags", s))
    );
    return {
      slug: r.data.slug,
      title: r.data.title,
      company: r.data.company,
      year: r.data.year,
      summary: r.data.summary,
      tags: rTags.filter(Boolean).map((t) => ({ name: t!.data.name, slug: t!.data.slug })),
      extraTagCount: Math.max(0, r.data.llmopsTags.length - 3),
    };
  })
);

// SEO
const seoTitle = entry.data.seo?.title || `${entry.data.title} - ZenML LLMOps Database`;
const seoDescription = entry.data.seo?.description || entry.data.summary;
const ogImage = entry.data.seo?.ogImage;
---

<BaseLayout
  title={seoTitle}
  description={seoDescription}
  ogImage={ogImage}
  ogTitle={entry.data.seo?.ogTitle}
  ogDescription={entry.data.seo?.ogDescription}
  canonical={entry.data.seo?.canonical}
>
  <div class="mx-auto max-w-4xl px-4 py-12 sm:px-6 lg:px-8" data-pagefind-body>
    {/* Pagefind metadata — slug for result→item mapping, year for sort */}
    <span data-pagefind-meta={`slug:${entry.data.slug}`} class="hidden" />
    {entry.data.company && <span data-pagefind-meta={`company:${entry.data.company}`} class="hidden" />}
    {entry.data.year && <span data-pagefind-meta={`year:${entry.data.year}`} class="hidden" />}

    {/* Pagefind filters — for native filtering (tags + industry) */}
    {tags.map((tag) => (
      <span data-pagefind-filter={`tag:${tag.slug}`} class="hidden" />
    ))}
    {industryEntry && (
      <span data-pagefind-filter={`industry:${industryEntry.data.slug}`} class="hidden" />
    )}

    {/* Breadcrumb */}
    <nav class="mb-8 flex items-center gap-2 text-sm text-gray-500" data-pagefind-ignore>
      <a href="/llmops-database" class="hover:text-primary-600">LLMOps Database</a>
      <svg class="h-4 w-4 text-gray-400" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round">
        <path d="M7.5 5L12.5 10L7.5 15" />
      </svg>
      <span class="text-gray-900 line-clamp-1">{entry.data.title}</span>
    </nav>

    {/* Header */}
    <header class="mb-8">
      <h1 class="text-3xl font-bold tracking-tight text-gray-900" data-pagefind-meta="title">{entry.data.title}</h1>

      <div class="mt-4 flex flex-wrap items-center gap-3 text-sm text-gray-500">
        {entry.data.company && (
          <span class="font-medium text-gray-700">{entry.data.company}</span>
        )}
        {entry.data.year && (
          <>
            <span aria-hidden="true">&middot;</span>
            <span>{entry.data.year}</span>
          </>
        )}
      </div>

      {entry.data.link && (
        <a
          href={entry.data.link}
          class="mt-4 inline-flex items-center gap-2 rounded-lg bg-primary-600 px-5 py-2.5 text-sm font-medium text-white transition-colors hover:bg-primary-700"
          target="_blank"
          rel="noopener noreferrer"
        >
          View original source
          <svg class="h-4 w-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 3H3v10h10v-3M9 2h5v5M14 2L7 9" />
          </svg>
        </a>
      )}
    </header>

    {/* Summary */}
    {entry.data.summary && (
      <div class="mb-8 rounded-lg border border-gray-200 bg-gray-50 p-6">
        <p class="text-gray-700">{entry.data.summary}</p>
      </div>
    )}

    {/* Industry */}
    {industryEntry && (
      <div class="mb-6">
        <h2 class="mb-2 text-xs font-semibold uppercase tracking-wider text-gray-400">Industry</h2>
        <Badge href={`/industry-tags/${industryEntry.data.slug}`} variant="primary">
          {industryEntry.data.name}
        </Badge>
      </div>
    )}

    {/* Technologies */}
    {tags.length > 0 && (
      <div class="mb-8">
        <h2 class="mb-2 text-xs font-semibold uppercase tracking-wider text-gray-400">Technologies</h2>
        <div class="flex flex-wrap gap-2">
          {tags.map((tag) => (
            <Badge href={`/llmops-tags/${tag.slug}`} variant="blue">
              {tag.name}
            </Badge>
          ))}
        </div>
      </div>
    )}

    {/* Body content */}
    <div class="prose prose-gray max-w-none">
      <Content />
    </div>

    {/* More Like This */}
    {relatedWithTags.length > 0 && (
      <section class="mt-16 border-t border-gray-200 pt-10" data-pagefind-ignore>
        <h2 class="mb-6 text-xl font-bold text-gray-900">More Like This</h2>
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          {relatedWithTags.map((r) => (
            <a
              href={`/llmops-database/${r.slug}`}
              class="group flex flex-col rounded-lg border border-gray-200 bg-white p-5 transition-shadow hover:shadow-md"
            >
              <h3 class="font-semibold text-gray-900 group-hover:text-primary-600 line-clamp-2">
                {r.title}
              </h3>
              <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-gray-500">
                {r.company && <span class="font-medium text-gray-700">{r.company}</span>}
                {r.year && (
                  <>
                    {r.company && <span aria-hidden="true">&middot;</span>}
                    <span>{r.year}</span>
                  </>
                )}
              </div>
              {r.summary && (
                <p class="mt-2 text-sm text-gray-600 line-clamp-2">{r.summary}</p>
              )}
              {r.tags.length > 0 && (
                <div class="mt-auto flex flex-wrap gap-1 pt-3">
                  {r.tags.map((tag) => (
                    <span class="rounded-full bg-blue-50 px-2 py-0.5 text-xs text-blue-700">
                      {tag.name}
                    </span>
                  ))}
                  {r.extraTagCount > 0 && (
                    <span class="rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-500">
                      +{r.extraTagCount}
                    </span>
                  )}
                </div>
              )}
            </a>
          ))}
        </div>
      </section>
    )}
  </div>
</BaseLayout>
