---
/**
 * Author taxonomy page.
 *
 * Shows author bio + all blog posts by this author using the shared BlogCard.
 * Generates /author/<slug> for each author in the collection.
 */
import { getCollection, getEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import BlogCard from "../../components/blog/BlogCard.astro";
import CategoryBar from "../../components/blog/CategoryBar.astro";
import Image from "../../components/Image.astro";
import { getMainFeedPosts, getCategoryCounts } from "../../lib/blog";

export async function getStaticPaths() {
  const authors = await getCollection("authors");
  return authors.map((author) => ({
    params: { slug: author.data.slug },
    props: { author },
  }));
}

const { author } = Astro.props;

const allPosts = (
  await getCollection("blog", ({ data }) => !data.draft && data.author === author.data.slug)
).sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// Category bar data
const allFeedPosts = await getMainFeedPosts();
const categories = await getCategoryCounts(allFeedPosts);

// Resolve categories for cards
const categoryMap = new Map<string, { name: string; slug: string }>();
for (const post of allPosts) {
  if (post.data.category && !categoryMap.has(post.data.category)) {
    const cat = await getEntry("categories", post.data.category);
    if (cat) categoryMap.set(post.data.category, { name: cat.data.name, slug: cat.data.slug });
  }
}
---

<BaseLayout
  title={`${author.data.name} - ZenML Blog`}
  description={author.data.bio || `Blog posts by ${author.data.name} on the ZenML blog.`}
>
  <CategoryBar backLink categories={categories} />

  {/* Author header â€” gradient section */}
  <section class="bg-linear-to-t from-primary-50 to-white border-b border-gray-200">
    <div class="mx-auto max-w-[1440px] px-4 py-10 sm:px-6 sm:py-14 lg:px-8">
      <div class="flex items-center gap-6">
        {author.data.avatar && (
          <Image
            image={author.data.avatar}
            alt={author.data.name}
            class="h-20 w-20 rounded-full object-cover"
          />
        )}
        <div>
          <h1 class="text-3xl font-bold tracking-tight text-gray-900">{author.data.name}</h1>
          {author.data.bio && <p class="mt-2 text-base leading-relaxed text-gray-600">{author.data.bio}</p>}
          <div class="mt-3 flex items-center gap-4">
            <span class="text-sm text-gray-500">{allPosts.length} {allPosts.length === 1 ? "post" : "posts"}</span>
            {author.data.email && (
              <a href={`mailto:${author.data.email}`} class="text-sm font-medium text-primary-600 hover:text-primary-700">
                Email
              </a>
            )}
            {author.data.linkedin && (
              <a href={author.data.linkedin} class="text-sm font-medium text-primary-600 hover:text-primary-700" target="_blank" rel="noopener noreferrer">
                LinkedIn
              </a>
            )}
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="mx-auto max-w-[1440px] px-4 py-10 sm:px-6 lg:px-8">
    <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
      {allPosts.map((post) => {
        const category = categoryMap.get(post.data.category || "");
        return (
          <BlogCard
            href={`/blog/${post.data.slug}`}
            title={post.data.title}
            excerpt={post.data.seo?.description}
            image={post.data.mainImage}
            authorName={author.data.name}
            authorSlug={author.data.slug}
            readingTime={post.data.readingTime}
            categoryName={category?.name}
            categorySlug={category?.slug}
          />
        );
      })}
    </div>

    {allPosts.length === 0 && (
      <p class="text-center text-gray-500">No posts by this author yet.</p>
    )}
  </div>
</BaseLayout>
