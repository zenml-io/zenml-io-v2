---
/**
 * BrevoNewsletterForm — email signup form that POSTs to Brevo (Sendinblue).
 *
 * Uses fetch with mode: 'no-cors' to submit the form data.
 * Progressive enhancement: without JS the form POSTs directly to Brevo.
 * Scoped DOM queries via data-brevo-form attribute — safe for multiple instances.
 *
 * Pass `darkBg` when used inside a dark/purple container (adjusts input/button colors).
 */
import type { BrevoFormConfig } from "../../lib/formTypes";

interface Props {
  config: BrevoFormConfig;
  privacyHtml?: string;
  darkBg?: boolean;
}

const { config, privacyHtml, darkBg = false } = Astro.props;

const inputClass = darkBg
  ? "h-[60px] rounded-lg border-0 bg-white px-4 text-xl text-gray-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-white/50 sm:w-80"
  : "rounded-md border border-gray-300 px-4 py-3 text-sm shadow-sm focus:border-zenml-500 focus:outline-none focus:ring-1 focus:ring-zenml-500 sm:w-72";

const buttonClass = darkBg
  ? "inline-flex h-[60px] items-center justify-center rounded-lg bg-[var(--color-primary-700)] px-6 text-base font-semibold text-white shadow-button hover:brightness-110 transition disabled:opacity-50 disabled:cursor-not-allowed"
  : "inline-flex items-center justify-center rounded-md bg-zenml-500 px-5 py-3 text-sm font-semibold text-white shadow-button hover:bg-zenml-600 transition disabled:opacity-50 disabled:cursor-not-allowed";

const successClass = darkBg
  ? "mt-3 hidden text-sm font-medium text-green-100"
  : "mt-3 hidden text-sm font-medium text-green-600";

const errorClass = darkBg
  ? "mt-3 hidden text-sm font-medium text-red-100"
  : "mt-3 hidden text-sm font-medium text-red-600";

const privacyClass = darkBg
  ? "mt-4 text-xs text-white/70"
  : "mt-4 text-xs text-gray-500";
---

<div data-brevo-form={config.formId} data-loading-label={config.loadingLabel}>
  <form
    method="POST"
    action={config.action}
    class="flex flex-col gap-3 sm:flex-row"
    data-brevo-newsletter
  >
    <label for={`brevo-email-${config.formId}`} class="sr-only">Email address</label>
    <input
      id={`brevo-email-${config.formId}`}
      type="email"
      name="EMAIL"
      required
      placeholder="Email address"
      autocomplete="email"
      class={inputClass}
    />
    <button
      type="submit"
      class={buttonClass}
    >
      {config.submitLabel}
    </button>
    {/* Brevo honeypot + locale */}
    <input type="text" name="email_address_check" value="" class="hidden" tabindex="-1" aria-hidden="true" />
    <input type="hidden" name="locale" value="en" />
  </form>

  <p class={successClass} data-brevo-success>
    Thanks for subscribing! Check your inbox to confirm.
  </p>
  <p class={errorClass} data-brevo-error></p>

  {privacyHtml && <p class={privacyClass} set:html={privacyHtml} />}

  <script is:inline>
    (function () {
      const script = document.currentScript;
      if (!(script instanceof HTMLScriptElement)) return;

      const root = script.parentElement;
      if (!(root instanceof HTMLElement)) return;

      const form = root.querySelector("[data-brevo-newsletter]");
      if (!(form instanceof HTMLFormElement)) return;
      if (form.dataset.brevoEnhanced === "true") return;
      form.dataset.brevoEnhanced = "true";

      const loadingLabel = root.dataset.loadingLabel || "Subscribing...";
      const successMsg = root.querySelector("[data-brevo-success]");
      const errorMsg = root.querySelector("[data-brevo-error]");

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        const btn = form.querySelector("button[type=submit]");
        const originalText = btn?.textContent;

        if (btn instanceof HTMLButtonElement) {
          btn.disabled = true;
          btn.textContent = loadingLabel;
        }

        const formData = new FormData(form);

        fetch(form.action, {
          method: "POST",
          body: formData,
          mode: "no-cors",
        })
          .then(function () {
            form.classList.add("hidden");
            successMsg?.classList.remove("hidden");
          })
          .catch(function (err) {
            console.error("Brevo submit error:", err);
            if (errorMsg instanceof HTMLElement) {
              errorMsg.textContent = "Subscription failed. Please try again.";
              errorMsg.classList.remove("hidden");
            }
            if (btn instanceof HTMLButtonElement) {
              btn.textContent = originalText;
              btn.disabled = false;
            }
          });
      });
    })();
  </script>
</div>
