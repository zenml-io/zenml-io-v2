---
/**
 * Navigation — responsive navbar matching the zenml.io Webflow site.
 * Desktop: hover-driven dropdown panels with two-column layout.
 * Mobile: hamburger toggle with accordion sections.
 */
import { NAV_DROPDOWNS, NAV_LINKS, NAV_CTAS, isActivePath } from "../lib/navigation";
import Button from "./Button.astro";

interface Props {
  currentPath?: string;
}

const { currentPath = Astro.url.pathname } = Astro.props;
---

<header class="sticky top-0 z-50 w-full bg-white/95 backdrop-blur-sm border-b border-gray-200/60">
  <div class="mx-auto max-w-[var(--container-lg)] px-4 sm:px-6 lg:px-8">
    <div class="flex h-[72px] items-center justify-between">
      {/* Logo */}
      <a href="/" class="flex shrink-0 items-center gap-2">
        <img
          src="/images/zenml-logo.svg"
          alt="ZenML"
          width="115"
          height="28"
          class="h-7 w-auto"
        />
      </a>

      {/* Desktop Nav */}
      <nav class="hidden lg:flex lg:items-center lg:gap-1 h-full" role="navigation" aria-label="Main navigation">
        {/* Dropdown menus */}
        {NAV_DROPDOWNS.map((dropdown) => (
          <div class="group flex h-full items-center">
            <button
              class="flex items-center gap-1 rounded-md px-3 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50 hover:text-gray-900"
              aria-expanded="false"
              aria-haspopup="true"
            >
              {dropdown.label}
              <svg class="h-4 w-4 text-gray-400 transition-transform group-hover:rotate-180" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 7.5L10 12.5L15 7.5" />
              </svg>
            </button>
            {/* Dropdown panel — positioned relative to the <header> (sticky = containing block) */}
            <div class="pointer-events-none invisible absolute inset-x-0 top-full z-50 opacity-0 transition-[opacity,visibility] duration-200 group-hover:pointer-events-auto group-hover:visible group-hover:opacity-100 group-focus-within:pointer-events-auto group-focus-within:visible group-focus-within:opacity-100">
              <div class="bg-white shadow-large border-b border-gray-100">
              <div class="mx-auto max-w-[var(--container-lg)] px-4 sm:px-6 lg:px-8">
                <div class="flex">
                  {/* Left: link columns */}
                  <div class="flex flex-1 gap-0 p-5">
                    {dropdown.sections.slice(0, 2).map((section) => (
                      <div class="flex-1 px-2">
                        <div class="mb-3 text-xs font-semibold uppercase tracking-wider text-gray-400">
                          {section.heading}
                        </div>
                        <div class="space-y-1">
                          {section.links.map((link) => (
                            <a
                              href={link.href}
                              class="group/link flex items-start gap-3 rounded-md p-2 transition-colors hover:bg-gray-50"
                              target={link.external ? "_blank" : undefined}
                              rel={link.external ? "noopener noreferrer" : undefined}
                            >
                              <div class="flex h-8 w-8 shrink-0 items-center justify-center rounded-md bg-zenml-25 text-zenml-500">
                                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                  <path d="M13 2L4.09 12.69a.5.5 0 00.41.81H12l-1 10 8.91-10.69a.5.5 0 00-.41-.81H12l1-10z" />
                                </svg>
                              </div>
                              <div>
                                <div class="text-sm font-medium text-gray-900 group-hover/link:text-zenml-500">
                                  {link.label}
                                </div>
                                {link.description && (
                                  <div class="mt-0.5 text-xs text-gray-500 leading-snug">
                                    {link.description}
                                  </div>
                                )}
                              </div>
                            </a>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                  {/* Right: featured/organization section */}
                  {(dropdown.sections.length > 2 || dropdown.featured) && (
                    <div class="w-[220px] border-l border-gray-100 bg-gray-50 p-5">
                      {dropdown.sections.length > 2 && (
                        <div class="mb-4">
                          <div class="mb-3 text-xs font-semibold uppercase tracking-wider text-gray-400">
                            {dropdown.sections[2].heading}
                          </div>
                          <div class="space-y-1">
                            {dropdown.sections[2].links.map((link) => (
                              <a
                                href={link.href}
                                class="group/link flex items-start gap-3 rounded-md p-2 transition-colors hover:bg-gray-100"
                              >
                                <div>
                                  <div class="text-sm font-medium text-gray-900 group-hover/link:text-zenml-500">
                                    {link.label}
                                  </div>
                                  {link.description && (
                                    <div class="mt-0.5 text-xs text-gray-500 leading-snug">
                                      {link.description}
                                    </div>
                                  )}
                                </div>
                              </a>
                            ))}
                          </div>
                        </div>
                      )}
                      {dropdown.featured && (
                        <div>
                          <div class="mb-3 text-xs font-semibold uppercase tracking-wider text-gray-400">
                            {dropdown.featured.heading}
                          </div>
                          {dropdown.featured.caseStudies?.map((cs) => (
                            <a
                              href={cs.href}
                              class="mb-2 block rounded-md p-2 transition-colors hover:bg-gray-100"
                            >
                              <div class="text-sm font-medium text-gray-900">{cs.label}</div>
                              <div class="text-xs text-gray-500">{cs.subtitle}</div>
                            </a>
                          ))}
                          {dropdown.featured.links?.map((link) => (
                            <a
                              href={link.href}
                              class="mb-2 block rounded-md p-2 transition-colors hover:bg-gray-100"
                              target={link.external ? "_blank" : undefined}
                              rel={link.external ? "noopener noreferrer" : undefined}
                            >
                              <div class="text-sm font-medium text-gray-900">{link.label}</div>
                              {link.description && (
                                <div class="text-xs text-gray-500">{link.description}</div>
                              )}
                            </a>
                          ))}
                          {dropdown.featured.ctaHref && (
                            <a
                              href={dropdown.featured.ctaHref}
                              class="mt-2 inline-flex items-center gap-1 text-sm font-medium text-zenml-500 hover:text-zenml-600"
                            >
                              {dropdown.featured.ctaLabel}
                              <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4.167 10h11.666M10.5 4.167L15.833 10 10.5 15.833" />
                              </svg>
                            </a>
                          )}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
              </div>
            </div>
          </div>
        ))}

        {/* Direct links */}
        {NAV_LINKS.map((link) => (
          <a
            href={link.href}
            class:list={[
              "rounded-md px-3 py-2 text-sm font-medium transition-colors hover:bg-gray-50",
              isActivePath(currentPath, link.href)
                ? "text-zenml-500"
                : "text-gray-700 hover:text-gray-900",
            ]}
          >
            {link.label}
          </a>
        ))}
      </nav>

      {/* Desktop CTAs */}
      <div class="hidden lg:flex lg:items-center lg:gap-3">
        <div class="min-w-[40px] h-[28px]">
          <a
            class="github-button"
            href="https://github.com/zenml-io/zenml"
            data-size="large"
            data-show-count="true"
            aria-label="Star zenml-io/zenml on GitHub"
          >Star</a>
        </div>
        <Button href={NAV_CTAS[0].href} variant="secondary" size="sm">
          {NAV_CTAS[0].label}
        </Button>
        <Button href={NAV_CTAS[1].href} variant="primary" size="sm">
          {NAV_CTAS[1].label}
        </Button>
      </div>

      {/* Mobile menu button */}
      <button
        type="button"
        class="lg:hidden rounded-md p-2 text-gray-700 hover:bg-gray-50"
        aria-label="Toggle menu"
        data-mobile-toggle
      >
        <svg class="h-6 w-6 block" data-icon="open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="6" x2="21" y2="6" />
          <line x1="3" y1="12" x2="21" y2="12" />
          <line x1="3" y1="18" x2="21" y2="18" />
        </svg>
        <svg class="h-6 w-6 hidden" data-icon="close" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
    </div>
  </div>

  {/* Mobile menu */}
  <div class="hidden lg:hidden" data-mobile-menu>
    <div class="border-t border-gray-200 bg-white px-4 pb-6 pt-4">
      <nav class="space-y-1" role="navigation" aria-label="Mobile navigation">
        {/* Mobile dropdown sections (as accordions) */}
        {NAV_DROPDOWNS.map((dropdown) => (
          <details class="group/accordion">
            <summary class="flex cursor-pointer items-center justify-between rounded-md px-3 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 list-none [&::-webkit-details-marker]:hidden">
              {dropdown.label}
              <svg class="h-4 w-4 text-gray-400 transition-transform group-open/accordion:rotate-180" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 7.5L10 12.5L15 7.5" />
              </svg>
            </summary>
            <div class="ml-4 mt-1 space-y-3 border-l border-gray-200 pl-4 pb-2">
              {dropdown.sections.map((section) => (
                <div>
                  <div class="mb-1.5 text-xs font-semibold uppercase tracking-wider text-gray-400">
                    {section.heading}
                  </div>
                  {section.links.map((link) => (
                    <a
                      href={link.href}
                      class="block rounded-md px-2 py-1.5 text-sm text-gray-600 hover:bg-gray-50 hover:text-gray-900"
                      target={link.external ? "_blank" : undefined}
                      rel={link.external ? "noopener noreferrer" : undefined}
                    >
                      {link.label}
                    </a>
                  ))}
                </div>
              ))}
              {dropdown.featured?.links?.map((link) => (
                <a
                  href={link.href}
                  class="block rounded-md px-2 py-1.5 text-sm text-gray-600 hover:bg-gray-50 hover:text-gray-900"
                  target={link.external ? "_blank" : undefined}
                  rel={link.external ? "noopener noreferrer" : undefined}
                >
                  {link.label}
                </a>
              ))}
            </div>
          </details>
        ))}

        {/* Mobile direct links */}
        {NAV_LINKS.map((link) => (
          <a
            href={link.href}
            class:list={[
              "block rounded-md px-3 py-2.5 text-sm font-medium hover:bg-gray-50",
              isActivePath(currentPath, link.href)
                ? "text-zenml-500"
                : "text-gray-700",
            ]}
          >
            {link.label}
          </a>
        ))}

        {/* Mobile CTAs */}
        <div class="mt-4 flex flex-col gap-2 pt-4 border-t border-gray-200">
          <Button href={NAV_CTAS[0].href} variant="secondary" size="md" class="w-full justify-center">
            {NAV_CTAS[0].label}
          </Button>
          <Button href={NAV_CTAS[1].href} variant="primary" size="md" class="w-full justify-center">
            {NAV_CTAS[1].label}
          </Button>
        </div>
      </nav>
    </div>
  </div>
</header>

<script>
  // Mobile menu toggle — minimal JS (no framework needed)
  const toggle = document.querySelector("[data-mobile-toggle]");
  const menu = document.querySelector("[data-mobile-menu]");
  const openIcon = toggle?.querySelector('[data-icon="open"]');
  const closeIcon = toggle?.querySelector('[data-icon="close"]');

  toggle?.addEventListener("click", () => {
    const isOpen = !menu?.classList.contains("hidden");
    menu?.classList.toggle("hidden", isOpen);
    openIcon?.classList.toggle("hidden", !isOpen);
    openIcon?.classList.toggle("block", isOpen);
    closeIcon?.classList.toggle("hidden", isOpen);
    closeIcon?.classList.toggle("block", !isOpen);
  });
</script>
