---
/**
 * BlogTOC — sticky table of contents for blog posts.
 *
 * Renders heading links with scroll-spy highlighting via IntersectionObserver.
 * Only renders if there are ≥3 headings.
 */
interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
}

const { headings } = Astro.props;

// Filter to h2 and h3 only (h1 is the post title)
const tocHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
---

{tocHeadings.length >= 3 && (
  <nav class="text-sm" aria-label="Table of contents" data-toc>
    <p class="mb-3 text-xs font-semibold uppercase tracking-wider text-gray-400">
      On this page
    </p>
    <ul class="space-y-2 border-l border-gray-200">
      {tocHeadings.map((heading) => (
        <li>
          <a
            href={`#${heading.slug}`}
            class:list={[
              "block border-l-2 -ml-px transition-colors duration-150",
              "text-gray-500 hover:text-gray-900 border-transparent hover:border-gray-400",
              heading.depth === 3 ? "pl-6 text-xs" : "pl-4",
            ]}
            data-toc-link={heading.slug}
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
)}

<script>
  function initScrollSpy() {
    const tocLinks = document.querySelectorAll<HTMLAnchorElement>("[data-toc-link]");
    if (tocLinks.length === 0) return;

    const slugs = Array.from(tocLinks).map((a) => a.dataset.tocLink!);
    const headingEls = slugs
      .map((slug) => document.getElementById(slug))
      .filter(Boolean) as HTMLElement[];

    if (headingEls.length === 0) return;

    let activeSlug = "";

    function setActive(slug: string) {
      if (slug === activeSlug) return;
      activeSlug = slug;
      tocLinks.forEach((link) => {
        const isActive = link.dataset.tocLink === slug;
        link.classList.toggle("text-zenml-500", isActive);
        link.classList.toggle("border-zenml-500", isActive);
        link.classList.toggle("font-medium", isActive);
        link.classList.toggle("text-gray-500", !isActive);
        link.classList.toggle("border-transparent", !isActive);
      });
    }

    const observer = new IntersectionObserver(
      (entries) => {
        // Find the first heading that's intersecting (visible)
        for (const entry of entries) {
          if (entry.isIntersecting) {
            setActive(entry.target.id);
            return;
          }
        }
      },
      {
        rootMargin: "-80px 0px -70% 0px",
        threshold: 0,
      },
    );

    headingEls.forEach((el) => observer.observe(el));

    // Set initial active heading
    if (headingEls.length > 0) {
      setActive(headingEls[0].id);
    }
  }

  // Run after DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initScrollSpy);
  } else {
    initScrollSpy();
  }
</script>
